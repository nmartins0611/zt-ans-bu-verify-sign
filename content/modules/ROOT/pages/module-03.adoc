= Lab Guide: Sign and Validate a Project

_A guide to signing an empty project using ansible-sign and validating it in automation controller._

---

[discrete]
====
*Estimated time to complete: 10 minutes*
====

In this challenge, you will sign the empty `ansible-sign-demo` repository using the `ansible-sign` tool. You will then push the signatures to Gitea and import the repository as a Project in automation controller to verify its integrity.

---

== Task 1: Create a MANIFEST.in File

First, create a `MANIFEST.in` file in the `ansible-sign-demo` local repository. This file acts as a directive, telling the `ansible-sign` tool which files to include or exclude from the signature.

Run the following command in the `Terminal` window:

[source,bash]
----
cat << EOF > /home/rhel/ansible-sign-demo/MANIFEST.in
recursive-exclude .git *
include README.md
EOF
----

---

== Task 2: Sign the Project with ansible-sign

Now, run the following command in the `Terminal` to sign the project:

[source,bash]
----
ansible-sign project gpg-sign ansible-sign-demo
----

This command signs the `ansible-sign-demo` project. You can confirm that new files were created in the `.ansible-sign` directory. `ansible-sign` used the `MANIFEST.in` file to determine what to sign, notably excluding the `.git` directory.

Let's inspect the new files. First, change into the project directory:

[source,bash]
----
cd ansible-sign-demo
----

View the `MANIFEST.in` file:

[source,bash]
----
cat MANIFEST.in
----

Now check the checksums and signature files. These files help automation controller validate the project's integrity.

[source,text]
----
cat .ansible-sign/sha256sum.txt
----
[source,text]
----
cat .ansible-sign/sha256sum.txt.sig
----

---

== Task 3: Push Signatures to Gitea

[IMPORTANT]
====
.Gitea Credentials
* **Username:** `gitea`
* **Password:** `gitea`
====

Add the new signature files to git staging:

[source,bash]
----
git add .ansible-sign/ MANIFEST.in
----

Commit the changes:

[source,bash]
----
git commit -m "Adding signatures for empty project"
----

Push the new files to the Gitea SCM. This system has credentials cached, so you do not need to log in.

[source,bash]
----
git push
----

---

== Task 4: Import and Validate the Project in Automation Controller

Now you will add your public key to automation controller as a credential and create a new project that uses it for validation.

=== Create the GPG Credential

First, you need to add the public key (which you created in the previous challenge) to automation controller. Copy the key to your clipboard by displaying its contents in the terminal:

[source,bash]
----
cat ~/signing_demo.asc
----

Go to the `Automation-Controller` tab and log in using the credentials below. Navigate to **Automation Execution** → **Infrastructure ->**Credentials** and click **Create credential**.

[IMPORTANT]
====
.Automation Controller Credentials
* **Username:** `admin`
* **Password:** `ansible123!`
====

Fill out the form with these details:

* **Name:** `ansible-sign`
* **Credential Type:** `GPG Public Key`
* **Public Key:** Paste the entire public key contents (including the `-----BEGIN...` and `-----END...` headers and footers) from your clipboard.

Click **Save**.

=== Create the Project

Next, navigate to **Automation Execution** → **Projects** and click **Create project**. Fill out the form with the following details:

[cols="1,2a"]
|===
| Parameter | Value
| Name | `Signed Project`
| Source Control Type | `Git`
| Content Signature Validation Credential | `ansible-sign`
| Source Control URL | `http://gitea:3000/student/ansible-sign-demo.git`
|===

Click **Save**. This creates the project and automatically starts a sync job that will use your GPG credential for validation.

---

== Task 5: Check Signature Validation

Navigate to the **Jobs** view from the left menu. Click on the most recent job, which should be the project sync for your new `Signed Project`. If the job was successful, the signature validation passed.

You can also verify this by scrolling through the job output to find these tasks, which confirm the validation was successful:

[source,text]
----
PLAY [Perform project signature/checksum verification] *************************

TASK [Verify project content using GPG signature] ******************************
ok: [localhost]

TASK [Verify project content against checksum manifest] ************************
ok: [localhost]
----

In the next challenge, you will add more files to this project and see what happens if you forget to sign them.

---

== Summary

* You created a `MANIFEST.in` file, which tells the `ansible-sign` tool which files to sign.
* You used your public key as a credential in automation controller to verify the signature of the files in the project.

== Next Steps

Press the `Next` button below to go to the next challenge once you've completed the tasks.

== Troubleshooting

If you have encountered an issue or have noticed something not quite right, please link:https://github.com/ansible/workshops/issues/new[open an issue].
